<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand Intelligence Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F7F4; /* Warm Neutral Background */
            color: #4A5568;
        }
        .tab-active {
            border-color: #4299E1; /* Muted Accent Blue */
            color: #2B6CB0;
            background-color: #EBF8FF;
        }
        .tab-inactive {
            border-color: transparent;
            color: #718096;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 350px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Brand Intelligence Dashboard</h1>
                <p class="text-gray-500 mt-1">Real-time scraping analytics and data exploration.</p>
            </div>
            <div id="statusIndicator" class="flex items-center mt-4 sm:mt-0 py-2 px-4 rounded-full bg-gray-200 text-gray-700 transition-colors duration-300">
                <div id="statusIndicatorDot" class="w-3 h-3 rounded-full bg-gray-400 mr-3"></div>
                <span id="statusIndicatorText" class="font-semibold">Initializing</span>
            </div>
            <!-- Storage Status Indicator (NEW) -->
            <div id="storageStatus" class="flex items-center mt-4 sm:mt-0 py-2 px-4 rounded-full bg-gray-200 text-gray-700 ml-4">
                <span id="storageStatusText" class="font-semibold">Storage: Initializing...</span>
            </div>
        </header>

        <nav class="flex border-b-2 border-gray-200 mb-6">
            <button data-tab="dashboard" class="nav-tab py-3 px-6 font-semibold border-b-2 transition-colors duration-200 tab-active">Dashboard</button>
            <button data-tab="explorer" class="nav-tab py-3 px-6 font-semibold border-b-2 transition-colors duration-200 tab-inactive">Data Explorer</button>
            <button data-tab="logs" class="nav-tab py-3 px-6 font-semibold border-b-2 transition-colors duration-200 tab-inactive">Logs & Alerts</button>
        </nav>

        <main>
            <div id="dashboard" class="tab-content">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="md:col-span-2 lg:col-span-4 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">Task Control</h2>
                        <p class="text-sm text-gray-500 mb-4">Manage the data collection process. The simulation will run for a short duration, collecting mock data from various sources.</p>
                        <div class="flex flex-wrap gap-3">
                            <button id="startButton" class="bg-blue-500 text-white font-semibold py-2 px-5 rounded-lg shadow-sm hover:bg-blue-600 transition duration-300 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="mr-2">▶</span> Start Scraping
                            </button>
                            <button id="stopButton" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-lg shadow-sm hover:bg-red-600 transition duration-300 flex items-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <span class="mr-2">■</span> Stop Scraping
                            </button>
                            <button id="scheduleButton" class="bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg shadow-sm hover:bg-gray-700 transition duration-300 flex items-center">
                                <span class="mr-2">◷</span> Schedule
                            </button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-md font-semibold text-gray-500">Total Brands Collected</h3>
                        <p id="kpiTotalBrands" class="text-4xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-md font-semibold text-gray-500">Total Runs</h3>
                        <p id="kpiTotalRuns" class="text-4xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-md font-semibold text-gray-500">Success Rate</h3>
                        <p id="kpiSuccessRate" class="text-4xl font-bold text-green-500 mt-2">0%</p>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-md font-semibold text-gray-500">Elapsed Time</h3>
                        <p id="elapsedTime" class="text-4xl font-bold text-gray-800 mt-2">00:00</p>
                    </div>

                    <div class="md:col-span-2 lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 class="text-lg font-semibold mb-2 text-gray-700">Run Status</h2>
                        <p class="text-sm text-gray-500 mb-4">A breakdown of all completed scraping tasks.</p>
                        <div class="chart-container">
                            <canvas id="runStatusChart"></canvas>
                        </div>
                    </div>
                    <div class="md:col-span-2 lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 class="text-lg font-semibold mb-2 text-gray-700">Brands by Source</h2>
                        <p class="text-sm text-gray-500 mb-4">Shows which sources are providing the most data.</p>
                         <div class="chart-container">
                            <canvas id="brandsBySourceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="explorer" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-700">Explore Collected Data</h2>
                            <p class="text-sm text-gray-500 mt-1">Search, review, and export all collected brand information.</p>
                        </div>
                        <button id="exportDataButton" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg shadow-sm hover:bg-green-700 transition duration-300 flex items-center mt-3 sm:mt-0">
                            <span class="mr-2">↓</span> Export Data
                        </button>
                    </div>
                    <input id="searchInput" type="text" placeholder="Search by name, founder, or classification..." class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-300">
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Logo</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Founder</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Classification</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Source</th>
                                </tr>
                            </thead>
                            <tbody id="brandsTableBody" class="divide-y divide-gray-200">
                                <tr><td colspan="5" class="text-center p-8 text-gray-500">No data collected yet. Start a scraping task to begin.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="logs" class="tab-content hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 class="text-lg font-semibold mb-2 text-gray-700">System Logs</h2>
                        <p class="text-sm text-gray-500 mb-4">Detailed operational messages from the scraper.</p>
                        <div id="logsContainer" class="bg-gray-800 text-white font-mono text-xs p-4 rounded-lg h-80 overflow-y-auto">
                            <p class="text-gray-400">> System initialized. Waiting for task...</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 class="text-lg font-semibold mb-2 text-gray-700">Alerts</h2>
                        <p class="text-sm text-gray-500 mb-4">Notifications for errors or significant events.</p>
                        <div id="alertsContainer" class="space-y-3 max-h-80 overflow-y-auto p-1">
                            <p class="text-gray-500">No alerts yet.</p>
                        </div>
                    </div>
                 </div>
            </div>

            <div class="bg-white p-4 rounded-lg border border-gray-200 mt-4">
                <h3 class="text-sm font-semibold text-gray-500 mb-2">Schedule State</h3>
                <div id="scheduleStatus" class="text-sm text-gray-500">No Schedule Set</div>
            </div>

            <div id="scheduleModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
                <div class="flex items-center justify-center min-h-screen p-4 text-center">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" id="scheduleOverlay"></div>
                    <div class="inline-block align-middle w-full max-w-md p-4 my-8 overflow-hidden text-left bg-white rounded-lg shadow-xl transform transition-all sm:my-0 sm:align-middle sm:max-w-lg">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4 border-b border-gray-200">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Set Schedule</h3>
                        </div>
                        <div class="bg-white px-4 py-5 sm:p-6 sm:pb-4">
                            <p class="text-sm text-gray-500 mb-4">Configure the scraper to run automatically or set a target for a manual run.</p>
                            <div class="mb-4">
                                <label for="scheduleFrequency" class="block text-sm font-medium text-gray-700 mb-2">Execution Frequency</label>
                                <select id="scheduleFrequency" class="w-full p-2 border border-gray-300 rounded-md">
                                    <option value="manual">Manual Start</option>
                                    <option value="daily" disabled>Daily (Feature coming soon)</option>
                                    <option value="weekly" disabled>Weekly (Feature coming soon)</option>
                                    <option value="monthly" disabled>Monthly (Feature coming soon)</option>
                                </select>
                            </div>
                            <div>
                                <label for="targetCountInput" class="block text-sm font-medium text-gray-700 mb-2">Brands Target</label>
                                <input type="number" id="targetCountInput" min="1" class="w-full p-2 border border-gray-300 rounded-md" value="50" placeholder="e.g., 100">
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-200">
                            <button type="button" id="saveScheduleBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Save Plan
                            </button>
                             <button type="button" id="closeScheduleModal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="exportModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
                <div class="flex items-center justify-center min-h-screen p-4 text-center">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" id="exportOverlay"></div>
                    <div class="inline-block align-middle w-full max-w-sm p-4 my-8 overflow-hidden text-left bg-white rounded-lg shadow-xl transform transition-all sm:my-0 sm:align-middle">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4 border-b border-gray-200">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Export Collected Data</h3>
                        </div>
                        <div class="bg-white px-4 py-5 sm:p-6 sm:pb-4">
                            <p class="text-sm text-gray-500 mb-4">Download the data to your device as a JSON or CSV file.</p>
                            <div class="flex flex-col space-y-3">
                                <button id="exportJsonButton" class="w-full bg-blue-500 text-white font-semibold py-2 px-5 rounded-lg shadow-sm hover:bg-blue-600 transition duration-300">Export as JSON</button>
                                <button id="exportCsvButton" class="w-full bg-green-500 text-white font-semibold py-2 px-5 rounded-lg shadow-sm hover:bg-green-600 transition duration-300">Export as CSV</button>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-200">
                             <button type="button" id="closeExportModal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Close
                          </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const scheduleButton = document.getElementById('scheduleButton');
        
        const statusIndicator = document.getElementById('statusIndicator');
        const statusIndicatorDot = document.getElementById('statusIndicatorDot');
        const statusIndicatorText = document.getElementById('statusIndicatorText');
        
        // --- Chart Contexts and Instances ---
        const runStatusCtx = document.getElementById('runStatusChart').getContext('2d');
        const brandsBySourceCtx = document.getElementById('brandsBySourceChart').getContext('2d');
        let runStatusChart, brandsBySourceChart;

        // --- Schedule Modal Elements ---
        const scheduleModal = document.getElementById('scheduleModal');
        const scheduleOverlay = document.getElementById('scheduleOverlay');
        const closeScheduleModal = document.getElementById('closeScheduleModal');
        const targetCountInput = document.getElementById('targetCountInput');
        const scheduleFrequency = document.getElementById('scheduleFrequency');
        const saveScheduleBtn = document.getElementById('saveScheduleBtn');
        const scheduleStatus = document.getElementById('scheduleStatus');

        // --- Export Modal Elements ---
        const exportDataButton = document.getElementById('exportDataButton');
        const exportModal = document.getElementById('exportModal');
        const exportOverlay = document.getElementById('exportOverlay');
        const closeExportModal = document.getElementById('closeExportModal');
        const exportJsonButton = document.getElementById('exportJsonButton');
        const exportCsvButton = document.getElementById('exportCsvButton');
        
        // Storage Status
        const storageStatus = document.getElementById('storageStatus');
        const storageStatusText = document.getElementById('storageStatusText');
        
        const kpiTotalBrands = document.getElementById('kpiTotalBrands');
        const kpiTotalRuns = document.getElementById('kpiTotalRuns');
        const kpiSuccessRate = document.getElementById('kpiSuccessRate');
        const elapsedTimeEl = document.getElementById('elapsedTime');

        const brandsTableBody = document.getElementById('brandsTableBody');
        const searchInput = document.getElementById('searchInput');

        const logsContainer = document.getElementById('logsContainer');
        const alertsContainer = document.getElementById('alertsContainer');

        // --- Local Database (IndexedDB) ---
        const DB_NAME = 'brandsCrapDB';
        const DB_VERSION = 1;
        const BRAND_STORE = 'brands';

        async function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => {
                    log('Database error: ' + event.target.error, 'error');
                    updateStorageStatus('error');
                    reject(event.target.error);
                };
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    log('Database initialized successfully', 'success');
                    updateStorageStatus('ready');
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(BRAND_STORE)) {
                        const store = db.createObjectStore(BRAND_STORE, { keyPath: 'name' });
                        store.createIndex('source', 'source', { unique: false });
                        store.createIndex('classification', 'classification', { unique: false });
                        log('Brand store created', 'success');
                    }
                };
            });
        }
        
        async function loadStoredBrands() {
            try {
                const db = await initDatabase();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(BRAND_STORE, 'readonly');
                    const store = transaction.objectStore(BRAND_STORE);
                    const request = store.getAll();
                    request.onsuccess = () => {
                        const brands = request.result;
                        log(`Loaded ${brands.length} brands from storage`, 'success');
                        resolve(brands);
                    };
                    request.onerror = () => {
                        log('Error loading stored brands', 'error');
                        reject(request.error);
                    };
                });
            } catch (error) {
                log('Failed to load stored brands: ' + error, 'error');
                updateStorageStatus('error');
                return [];
            }
        }

        async function saveBrands(brands) {
            try {
                const db = await initDatabase();
                const transaction = db.transaction(BRAND_STORE, 'readwrite');
                const store = transaction.objectStore(BRAND_STORE);

                for (const brand of brands) {
                    store.put(brand);
                }

                return new Promise((resolve, reject) => {
                    transaction.oncomplete = () => {
                        log(`Saved ${brands.length} brands to storage`, 'success');
                        updateStorageStatus('ready');
                        resolve();
                    };
                    transaction.onerror = () => {
                        log('Error saving brands', 'error');
                        updateStorageStatus('error');
                        reject(transaction.error);
                    };
                });
            } catch (error) {
                log('Failed to save brands: ' + error, 'error');
                addAlert('Failed to save brands to local storage', 'error');
                updateStorageStatus('error');
            }
        }


        // --- App State ---
        let state = {
            isScraping: false,
            timerInterval: null,
            elapsedSeconds: 0,
            allBrands: [],
            stats: {
                totalRuns: 0,
                successfulRuns: 0,
                failedRuns: 0,
                brandsBySource: {}
            },
            currentRunBrandCount: 0,
            targetBrandCount: 0, // 0 means no target
            scheduleFrequency: 'manual', // 'daily', 'weekly', 'monthly'
            isScheduled: false,
            scrapeInterval: null,
            dbInitialized: false,
            lastSyncTime: null
        };
        
        // --- Navigation ---
        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                navTabs.forEach(t => t.classList.replace('tab-active', 'tab-inactive'));
                tab.classList.replace('tab-inactive', 'tab-active');

                tabContents.forEach(content => {
                    content.classList.add('hidden');
                    if (content.id === tab.dataset.tab) {
                        content.classList.remove('hidden');
                    }
                });
            });
        });

        // --- Modal Initializers ---
        function initScheduleModal() {
            scheduleButton.addEventListener('click', () => scheduleModal.classList.remove('hidden'));
            closeScheduleModal.addEventListener('click', () => scheduleModal.classList.add('hidden'));
            scheduleOverlay.addEventListener('click', () => scheduleModal.classList.add('hidden'));
            saveScheduleBtn.addEventListener('click', saveSchedule);
        }

        function initExportModal() {
            exportDataButton.addEventListener('click', () => exportModal.classList.remove('hidden'));
            closeExportModal.addEventListener('click', () => exportModal.classList.add('hidden'));
            exportOverlay.addEventListener('click', () => exportModal.classList.add('hidden'));
            exportJsonButton.addEventListener('click', exportAsJSON);
            exportCsvButton.addEventListener('click', exportAsCSV);
        }

        // --- Chart Initialization ---
        function initCharts() {
            Chart.defaults.font.family = 'Inter';
            Chart.defaults.color = '#6b7280';

            const tooltipPlugin = {
                titleFont: { weight: 'bold' },
                bodyFont: { size: 14 },
                padding: 12,
                boxPadding: 4,
                cornerRadius: 8,
            };

            const legendPlugin = {
                position: 'bottom',
                labels: { padding: 20, font: { size: 14 } }
            };
            
            runStatusChart = new Chart(runStatusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Successful', 'Failed'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#48BB78', '#F56565'],
                        borderColor: '#F8F7F4',
                        borderWidth: 4,
                        hoverOffset: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: legendPlugin, tooltip: tooltipPlugin }
                }
            });

            brandsBySourceChart = new Chart(brandsBySourceCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Brands Collected',
                        data: [],
                        backgroundColor: '#63B3ED',
                        borderRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { drawBorder: false }, ticks: { precision: 0 } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false }, tooltip: tooltipPlugin }
                }
            });
        }

        // --- UI Update Functions ---
        function updateUI() {
            startButton.disabled = state.isScraping;
            stopButton.disabled = !state.isScraping;

            if (state.isScraping) {
                statusIndicator.className = 'flex items-center mt-4 sm:mt-0 py-2 px-4 rounded-full bg-blue-100 text-gray-700 transition-colors duration-300';
                statusIndicatorDot.className = 'w-3 h-3 rounded-full bg-blue-500 mr-3 animate-pulse';
                statusIndicatorText.textContent = 'Scraping...';
            } else if (state.stats.totalRuns > 0) {
                 statusIndicator.className = 'flex items-center mt-4 sm:mt-0 py-2 px-4 rounded-full bg-gray-200 text-gray-700 transition-colors duration-300';
                 statusIndicatorDot.className = 'w-3 h-3 rounded-full bg-red-500 mr-3';
                 statusIndicatorText.textContent = 'Stopped';
            } else {
                 statusIndicator.className = 'flex items-center mt-4 sm:mt-0 py-2 px-4 rounded-full bg-gray-200 text-gray-700 transition-colors duration-300';
                 statusIndicatorDot.className = 'w-3 h-3 rounded-full bg-gray-400 mr-3';
                 statusIndicatorText.textContent = 'Idle';
            }
            
            kpiTotalBrands.textContent = state.allBrands.length;
            kpiTotalRuns.textContent = state.stats.totalRuns;
            const successRate = state.stats.totalRuns > 0 ? Math.round((state.stats.successfulRuns / state.stats.totalRuns) * 100) : 0;
            kpiSuccessRate.textContent = `${successRate}%`;
            kpiSuccessRate.className = `text-4xl font-bold mt-2 ${successRate >= 70 ? 'text-green-500' : 'text-amber-500'}`;

            runStatusChart.data.datasets[0].data = [state.stats.successfulRuns, state.stats.failedRuns];
            runStatusChart.update('none');

            const sourceLabels = Object.keys(state.stats.brandsBySource);
            const sourceData = Object.values(state.stats.brandsBySource);
            brandsBySourceChart.data.labels = sourceLabels;
            brandsBySourceChart.data.datasets[0].data = sourceData;
            brandsBySourceChart.update('none');
            
            renderTable(state.allBrands, searchInput.value);
            updateStorageStatus('ready'); // Make sure UI shows up-to-date storage info        
        }
        
        function renderTable(brands, filter) {
            const normalizedFilter = filter.toLowerCase();
            const filteredBrands = brands.filter(b => 
                !filter || 
                b.name.toLowerCase().includes(normalizedFilter) ||
                b.founder.toLowerCase().includes(normalizedFilter) ||
                b.classification.toLowerCase().includes(normalizedFilter)
            );

            if (filteredBrands.length === 0) {
                brandsTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-500">${brands.length > 0 ? 'No brands match your search.' : 'No data collected yet. Start a scraping task to begin.'}</td></tr>`;
                return;
            }
            
            brandsTableBody.innerHTML = ''; 
            filteredBrands.forEach(brand => {
                 const row = document.createElement('tr');
                 row.className = "hover:bg-gray-50 transition-colors duration-150";
                 row.innerHTML = `
                    <td class="py-3 px-4"><img src="${brand.logo}" alt="${brand.name} logo" class="rounded-full h-10 w-10 object-cover bg-gray-200"></td>
                    <td class="py-3 px-4 font-medium text-gray-800">${brand.name}</td>
                    <td class="py-3 px-4">${brand.founder}</td>
                    <td class="py-3 px-4"><span class="px-2 py-1 font-semibold leading-tight text-blue-700 bg-blue-100 rounded-full text-xs">${brand.classification}</span></td>
                    <td class="py-3 px-4 text-sm text-gray-600">${brand.source}</td>
                `;
                brandsTableBody.prepend(row); // Prepend to show newest first
            });
        }

        // --- Storage Status UI (NEW) ---
        function updateStorageStatus(status) {
            if (!storageStatusText) return;
            switch (status) {
                case 'ready':
                    storageStatusText.textContent = `Storage: Ready (${state.allBrands.length} brands)`;
                    storageStatus.classList.remove('bg-red-200');
                    storageStatus.classList.add('bg-green-200');
                    break;
                case 'error':
                    storageStatusText.textContent = 'Storage: Error';
                    storageStatus.classList.remove('bg-green-200');
                    storageStatus.classList.add('bg-red-200');
                    break;
                default:
                    storageStatusText.textContent = 'Storage: Initializing...';
                    storageStatus.classList.remove('bg-green-200', 'bg-red-200');
            }
        }
        
        function log(message, type = 'info') {
            const p = document.createElement('p');
            const typeClasses = { error: 'text-red-400', warning: 'text-yellow-400', success: 'text-green-400', info: 'text-gray-400' };
            p.className = typeClasses[type] || 'text-gray-400';
            p.innerHTML = `<span class="text-gray-500 mr-2">${new Date().toLocaleTimeString()} &gt;</span> ${message}`;
            logsContainer.prepend(p);
        }

        function addAlert(message, type = 'warning') {
            if(alertsContainer.querySelector('.text-gray-500')) alertsContainer.innerHTML = '';
            const alertDiv = document.createElement('div');
            const C = {
                error: { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-300' },
                warning: { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-300' },
                success: { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-300'}
            }[type] || C.warning;
            alertDiv.className = `p-3 rounded-lg border ${C.bg} ${C.text} ${C.border}`;
            alertDiv.textContent = message;
            alertsContainer.prepend(alertDiv);
        }

        // --- Schedule Logic ---
        function saveSchedule() {
            const target = parseInt(targetCountInput.value);
            if (isNaN(target) || target < 1) {
                addAlert('Target number must be a positive number.', 'error');
                return;
            }
            
            state.scheduleFrequency = scheduleFrequency.value;
            state.targetBrandCount = target;
            state.isScheduled = true;
            
            updateScheduleStatus();
            scheduleModal.classList.add('hidden');
            log(`Scheduling saved: Target set to ${target} brands.`, 'success');
            addAlert(`Plan saved! The next manual run will aim for ${target} brands.`, 'success');
        }

        function updateScheduleStatus() {
            if (!state.isScheduled || state.targetBrandCount <= 0) {
                scheduleStatus.innerHTML = '<span class="text-gray-500">No Schedule Set</span>';
                return;
            }
            
            const frequencyMap = { 'manual': 'Manual Start', 'daily': 'Daily', 'weekly': 'Weekly', 'monthly': 'Monthly' };
            const freqText = frequencyMap[state.scheduleFrequency];
            let statusText = `<span class="text-blue-600 font-semibold">Target:</span> ${state.targetBrandCount} Brands | <span class="font-semibold">Mode:</span> ${freqText}`;
            scheduleStatus.innerHTML = statusText;
        }

        // --- Core Scraping Logic ---
        function startScraping() {
            if (state.isScraping) return;

            const useTarget = state.isScheduled && state.targetBrandCount > 0;
            const targetTotal = state.allBrands.length + state.targetBrandCount;

            state.isScraping = true;
            state.stats.totalRuns++;
            state.currentRunBrandCount = 0;
            
            if (useTarget) {
                 log(`Scraping process started with target: Collect ${state.targetBrandCount} new brands (total ${targetTotal}).`, 'success');
            } else {
                 log("Scraping process started.", 'success');
            }
           
            startTimer();
            updateUI();

            let targetIndex = 0;
            state.scrapeInterval = setInterval(() => {
                if (!state.isScraping) return;

                // Stop condition for non-target runs
                if (!useTarget && targetIndex >= mockTargets.length) {
                    stopScraping(true); // Successfully completed a full run
                    return;
                }
                
                // If we run out of targets, loop them for the simulation
                if (targetIndex >= mockTargets.length) {
                    targetIndex = 0; 
                }
                
                const target = mockTargets[targetIndex];
                log(`Scraping target: <strong>${target}</strong>`);

                const newBrandsCount = Math.floor(Math.random() * 5) + 1;
                for (let i = 0; i < newBrandsCount; i++) {
                    const newBrand = generateMockBrand(target);
                    state.allBrands.push(newBrand);
                    state.currentRunBrandCount++;
                    state.stats.brandsBySource[target] = (state.stats.brandsBySource[target] || 0) + 1;

                    // Stop condition for target-based runs
                    if (useTarget && state.allBrands.length >= targetTotal) {
                        log(`Target of ${targetTotal} total brands reached.`, 'success');
                        addAlert(`Successfully reached target, collected ${state.currentRunBrandCount} new brands.`, 'success');
                        stopScraping(true);
                        return; // Exit the loop and interval
                    }
                }
                
                if (Math.random() < 0.1) {
                    const errorMsg = `Error scraping ${target}.`;
                    log(errorMsg, 'error');
                    addAlert(`Failed to fetch from ${target}. The system will continue with other sources.`, 'error');
                }
                
                updateUI();
                targetIndex++;
            }, 1500);
        }

        function stopScraping(isSuccess = false) {
            if (!state.isScraping) return;
            clearInterval(state.scrapeInterval);
            state.isScraping = false;
            stopTimer();

            if (isSuccess) {
                state.stats.successfulRuns++;
                log(`Scraping process completed. Found <strong>${state.currentRunBrandCount}</strong> new brands this run.`, 'success');
            } else {
                state.stats.failedRuns++;
                log("Scraping process stopped by user.", 'warning');
                addAlert('Task stopped manually by user.', 'warning');
            }
            updateUI();
        }

        // --- Data Export Logic ---
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportAsJSON() {
            if (state.allBrands.length === 0) {
                addAlert("No data to export.", "warning");
                return;
            }
            const jsonData = JSON.stringify(state.allBrands, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            downloadBlob(blob, `brands-export-${new Date().toISOString()}.json`);
        }

        function exportAsCSV() {
            if (state.allBrands.length === 0) {
                addAlert("No data to export.", "warning");
                return;
            }
            const headers = ['name', 'founder', 'classification', 'source', 'logo'];
            const csvRows = [headers.join(',')]; // Header row

            state.allBrands.forEach(brand => {
                const values = headers.map(header => {
                    const escaped = ('' + brand[header]).replace(/"/g, '""'); // Escape double quotes
                    return `"${escaped}"`; // Quote all fields
                });
                csvRows.push(values.join(','));
            });

            const csvData = csvRows.join('\n');
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            downloadBlob(blob, `brands-export-${new Date().toISOString()}.csv`);
        }


        // --- Timer ---
        function startTimer() {
            state.elapsedSeconds = -1;
            updateTimer();
            state.timerInterval = setInterval(updateTimer, 1000);
        }
        function stopTimer() { clearInterval(state.timerInterval); }
        function updateTimer() {
             state.elapsedSeconds++;
             const m = String(Math.floor(state.elapsedSeconds / 60)).padStart(2, '0');
             const s = String(state.elapsedSeconds % 60).padStart(2, '0');
             elapsedTimeEl.textContent = `${m}:${s}`;
        }

        // --- Mock Data Generator ---
        function generateMockBrand(source) {
            const names = ["Apex", "Vortex", "Zenith", "Nova", "Pulse", "Fusion", "Equinox", "Orion", "Celeste"];
            const domains = ["Industries", "Dynamics", "Solutions", "Global", "Enterprises", "Labs", "Works"];
            const founders = ["J. Doe", "A. Smith", "K. Ray", "S. Wilson", "C. Lee", "M. Chen", "R. Singh"];
            const classifications = ["Technology", "Finance", "Healthcare", "Retail", "Automotive", "E-commerce", "SaaS"];
            
            const name = `${names[Math.floor(Math.random() * names.length)]} ${domains[Math.floor(Math.random() * domains.length)]}`;
            const logoText = name.split(" ").map(n => n[0]).join('');
            
            return {
                name: name,
                logo: `https://placehold.co/80x80/EBF8FF/2B6CB0?text=${logoText}&font=inter`,
                founder: founders[Math.floor(Math.random() * founders.length)],
                classification: classifications[Math.floor(Math.random() * classifications.length)],
                source: source
            };
        }
        
        // --- Event Listeners ---
        startButton.addEventListener('click', startScraping);
        stopButton.addEventListener('click', () => stopScraping(false));
        searchInput.addEventListener('input', () => renderTable(state.allBrands, searchInput.value));

        // --- Initial Load (MODIFIED) ---
        async function initializeApp() {
            updateStorageStatus(); // Show initializing state
            log("Initializing database...");
            // Load from local storage first
            try {
                const storedBrands = await loadStoredBrands();
                state.allBrands = storedBrands;
                state.dbInitialized = true;
                updateStorageStatus('ready');
            } catch (error) {
                updateStorageStatus('error');
            }
            log("Dashboard initialized successfully.");
            initCharts();
            initScheduleModal();
            initExportModal();
            updateUI();
            updateScheduleStatus();
        }
        
        initializeApp();
    </script>
</body>  
</html>
